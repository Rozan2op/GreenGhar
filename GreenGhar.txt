#include <WiFi.h>
#include <WebServer.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <DHT.h>

// ================= WIFI CREDENTIALS =================
const char* wifi_ssid = "Rozan2op";
const char* wifi_password = "Qwerty123";

// ================= PINS =================
#define SOIL_PIN 34
#define PUMP_PIN 26
#define LDR_PIN 35
#define LED_PIN 2
#define DHT_PIN 4
#define FLAME_PIN 27
#define BUZZER_PIN 25
#define MOTOR_PIN 33        // DC Motor pin (you can change to any available GPIO)
#define DHTTYPE DHT11

// ================= OBJECTS =================
WebServer server(80);
DHT dht(DHT_PIN, DHTTYPE);
LiquidCrystal_I2C lcd(0x27, 16, 2);

// ================= VARIABLES =================
int soilPercent = 0;
int ldrValue = 0;
float temperature = 0;
float humidity = 0;
String pumpStatus = "OFF";
String ledStatus = "OFF";
String flameStatus = "Safe";
String motorStatus = "OFF";

// Manual control flags
bool manualPumpControl = false;
bool manualLedControl = false;
bool manualMotorControl = false;
bool manualPumpState = false;
bool manualLedState = false;
bool manualMotorState = false;

// ================= THRESHOLDS =================
int soilThresholdLow = 10;   // Pump ON when soil <= 10%
int soilThresholdHigh = 20;  // Pump OFF when soil >= 20%
int ldrThreshold = 1000;
float tempThresholdHigh = 30.0;  // Motor ON when temp >= 30¬∞C
float tempThresholdLow = 30.0;   // Motor OFF when temp < 30¬∞C

// ==================================================
void setup() {
  Serial.begin(115200);
  delay(1000);
  
  pinMode(PUMP_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT);
  pinMode(FLAME_PIN, INPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(MOTOR_PIN, OUTPUT);  // Initialize motor pin
  
  digitalWrite(PUMP_PIN, LOW);
  digitalWrite(BUZZER_PIN, LOW);
  digitalWrite(LED_PIN, LOW);
  digitalWrite(MOTOR_PIN, LOW);  // Motor initially OFF
  
  dht.begin();
  
  Wire.begin(21, 22);
  lcd.init();
  lcd.backlight();
  lcd.setCursor(0, 0);
  lcd.print("Connecting WiFi");
  
  // ================= CONNECT TO WIFI =================
  WiFi.mode(WIFI_STA);
  WiFi.begin(wifi_ssid, wifi_password);
  Serial.print("Connecting to WiFi");
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi Connected!");
    Serial.print("IP address: ");
    Serial.println(WiFi.localIP());
    lcd.clear();
    lcd.print("WiFi Connected");
    lcd.setCursor(0, 1);
    lcd.print(WiFi.localIP());
  } else {
    Serial.println("\nWiFi Connection Failed!");
    lcd.clear();
    lcd.print("WiFi Failed!");
  }
  
  // ================= WEB SERVER =================
  server.on("/", handleRoot);
  server.on("/data", handleData);
  server.on("/control", handleControl);
  server.begin();
  Serial.println("Web Server Started");
  
  delay(3000);
}

// ==================================================
void loop() {
  server.handleClient();
  
  static unsigned long lastRead = 0;
  if (millis() - lastRead >= 2000) {
    lastRead = millis();
    readSensors();
    updateLCD();
  }
}

// ==================================================
void readSensors() {
  // Soil Moisture
  int soilRaw = analogRead(SOIL_PIN);
  soilPercent = map(soilRaw, 4095, 1500, 0, 100);
  soilPercent = constrain(soilPercent, 0, 100);
  
  // Pump control - manual or automatic
  if (manualPumpControl) {
    digitalWrite(PUMP_PIN, manualPumpState ? HIGH : LOW);
    pumpStatus = manualPumpState ? "ON" : "OFF";
  } else {
    // Hysteresis control: ON at <=10%, OFF at >=20%
    if (soilPercent <= soilThresholdLow) {
      digitalWrite(PUMP_PIN, HIGH);
      pumpStatus = "ON";
    } else if (soilPercent >= soilThresholdHigh) {
      digitalWrite(PUMP_PIN, LOW);
      pumpStatus = "OFF";
    }
    // Keep current state if between 10-20%
  }
  
  // LDR (Light Sensor)
  ldrValue = analogRead(LDR_PIN);
  
  // LED control - manual or automatic
  if (manualLedControl) {
    digitalWrite(LED_PIN, manualLedState ? HIGH : LOW);
    ledStatus = manualLedState ? "ON" : "OFF";
  } else {
    if (ldrValue < ldrThreshold) {
      digitalWrite(LED_PIN, HIGH);
      ledStatus = "ON";
    } else {
      digitalWrite(LED_PIN, LOW);
      ledStatus = "OFF";
    }
  }
  
  // DHT11
  temperature = dht.readTemperature();
  humidity = dht.readHumidity();
  if (isnan(temperature)) temperature = 0;
  if (isnan(humidity)) humidity = 0;
  
  // Flame Sensor
  int flame = digitalRead(FLAME_PIN);
  if (flame == LOW) {
    digitalWrite(BUZZER_PIN, HIGH);
    flameStatus = "FIRE";
  } else {
    digitalWrite(BUZZER_PIN, LOW);
    flameStatus = "Safe";
  }
  
  // DC Motor control based on temperature - manual or automatic
  if (manualMotorControl) {
    digitalWrite(MOTOR_PIN, manualMotorState ? HIGH : LOW);
    motorStatus = manualMotorState ? "ON" : "OFF";
  } else {
    // Motor ON when temp >= 30¬∞C, OFF when temp < 30¬∞C
    if (temperature >= tempThresholdHigh) {
      digitalWrite(MOTOR_PIN, HIGH);
      motorStatus = "ON";
    } else if (temperature < tempThresholdLow) {
      digitalWrite(MOTOR_PIN, LOW);
      motorStatus = "OFF";
    }
  }
}

// ==================================================
void updateLCD() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("S:");
  lcd.print(soilPercent);
  lcd.print("% P:");
  lcd.print(pumpStatus);
  lcd.print(" ");
  lcd.print(flameStatus);
  
  lcd.setCursor(0, 1);
  lcd.print("T:");
  lcd.print(temperature, 1);
  lcd.print("C H:");
  lcd.print(humidity, 0);
  lcd.print("% M:");
  lcd.print(motorStatus);
}

// ==================================================
void handleControl() {
  String response = "OK";
  
  if (server.hasArg("pump")) {
    String pumpCmd = server.arg("pump");
    if (pumpCmd == "on") {
      manualPumpControl = true;
      manualPumpState = true;
      digitalWrite(PUMP_PIN, HIGH);
      pumpStatus = "ON";
      response = "PUMP_ON";
    } else if (pumpCmd == "off") {
      manualPumpControl = true;
      manualPumpState = false;
      digitalWrite(PUMP_PIN, LOW);
      pumpStatus = "OFF";
      response = "PUMP_OFF";
    } else if (pumpCmd == "auto") {
      manualPumpControl = false;
      response = "PUMP_AUTO";
    }
  }
  
  if (server.hasArg("led")) {
    String ledCmd = server.arg("led");
    if (ledCmd == "on") {
      manualLedControl = true;
      manualLedState = true;
      digitalWrite(LED_PIN, HIGH);
      ledStatus = "ON";
      response = "LED_ON";
    } else if (ledCmd == "off") {
      manualLedControl = true;
      manualLedState = false;
      digitalWrite(LED_PIN, LOW);
      ledStatus = "OFF";
      response = "LED_OFF";
    } else if (ledCmd == "auto") {
      manualLedControl = false;
      response = "LED_AUTO";
    }
  }
  
  if (server.hasArg("motor")) {
    String motorCmd = server.arg("motor");
    if (motorCmd == "on") {
      manualMotorControl = true;
      manualMotorState = true;
      digitalWrite(MOTOR_PIN, HIGH);
      motorStatus = "ON";
      response = "MOTOR_ON";
    } else if (motorCmd == "off") {
      manualMotorControl = true;
      manualMotorState = false;
      digitalWrite(MOTOR_PIN, LOW);
      motorStatus = "OFF";
      response = "MOTOR_OFF";
    } else if (motorCmd == "auto") {
      manualMotorControl = false;
      response = "MOTOR_AUTO";
    }
  }
  
  server.sendHeader("Access-Control-Allow-Origin", "*");
  server.send(200, "text/plain", response);
  Serial.print("Control: ");
  Serial.println(response);
}

// ==================================================
void handleData() {
  String json = "{";
  json += "\"temperature\":" + String(temperature, 1) + ",";
  json += "\"humidity\":" + String(humidity, 1) + ",";
  json += "\"soilMoisture\":" + String(soilPercent) + ",";
  json += "\"lightLevel\":" + String(ldrValue) + ",";
  json += "\"flameDetected\":" + String(flameStatus == "FIRE" ? "true" : "false") + ",";
  json += "\"pumpStatus\":" + String(pumpStatus == "ON" ? "true" : "false") + ",";
  json += "\"ledStatus\":" + String(ledStatus == "ON" ? "true" : "false") + ",";
  json += "\"motorStatus\":" + String(motorStatus == "ON" ? "true" : "false") + ",";
  json += "\"manualPump\":" + String(manualPumpControl ? "true" : "false") + ",";
  json += "\"manualLed\":" + String(manualLedControl ? "true" : "false") + ",";
  json += "\"manualMotor\":" + String(manualMotorControl ? "true" : "false");
  json += "}";
  
  server.send(200, "application/json", json);
}

// ==================================================
void handleRoot() {
  String html = "";
  html += "<!DOCTYPE html>";
  html += "<html>";
  html += "<head>";
  html += "<meta name='viewport' content='width=device-width, initial-scale=1.0'>";
  html += "<meta charset='UTF-8'>";
  html += "<title>Smart Agriculture</title>";
  
  // CSS Styles - Exact match from your screenshot with adjustments
  html += "<style>";
  html += "* { margin: 0; padding: 0; box-sizing: border-box; }";
  html += "body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }";
  html += ".container { max-width: 1100px; margin: 0 auto; }";
  html += ".header { background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%); border-radius: 25px; padding: 30px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-bottom: 25px; }";
  html += ".header h1 { color: #2c3e50; font-size: 2.5em; margin-bottom: 8px; font-weight: 700; }";
  html += ".header p { color: #7f8c8d; font-size: 1.1em; font-weight: 500; }";
  html += ".sensor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }";
  html += ".sensor-card { border-radius: 20px; padding: 30px 25px; text-align: left; box-shadow: 0 8px 25px rgba(0,0,0,0.15); transition: transform 0.3s, box-shadow 0.3s; position: relative; overflow: hidden; }";
  html += ".sensor-card:hover { transform: translateY(-8px); box-shadow: 0 12px 30px rgba(0,0,0,0.2); }";
  html += ".sensor-card:nth-child(1) { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }";
  html += ".sensor-card:nth-child(2) { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); }";
  html += ".sensor-card:nth-child(3) { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }";
  html += ".sensor-label { color: rgba(255,255,255,0.95); font-size: 1.2em; margin-bottom: 12px; font-weight: 600; display: flex; align-items: center; gap: 10px; }";
  html += ".sensor-value { color: white; font-size: 3.5em; font-weight: 800; margin-bottom: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }";
  html += ".sensor-unit { color: rgba(255,255,255,0.9); font-size: 1.3em; font-weight: 600; }";
  html += ".status-section { background: transparent; padding: 0; margin-top: 15px; }";
  html += ".status-section h2 { color: #ffffff; margin-bottom: 25px; font-size: 2em; font-weight: 700; display: flex; align-items: center; gap: 12px; padding-bottom: 12px; border-bottom: 3px solid rgba(255,255,255,0.3); }";
  html += ".status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }";
  html += ".status-item { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 20px; padding: 30px 20px; text-align: center; box-shadow: 0 6px 20px rgba(0,0,0,0.12); transition: all 0.3s; }";
  html += ".status-item:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.18); }";
  html += ".status-item.active-green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }";
  html += ".status-item.active-green .status-text { color: white; }";
  html += ".status-icon { font-size: 3.5em; margin-bottom: 12px; background: rgba(255,255,255,0.9); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }";
  html += ".status-item.active-green .status-icon { background: rgba(255,255,255,0.25); }";
  html += ".status-text { font-size: 1.3em; font-weight: 700; color: #5a6c7d; margin-bottom: 18px; letter-spacing: 0.5px; }";
  html += ".status-item.active-green .status-text { color: white; }";
  html += ".control-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 18px; flex-wrap: wrap; }";
  html += ".btn { padding: 11px 24px; border: none; border-radius: 10px; font-size: 1em; font-weight: 700; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }";
  html += ".btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.25); }";
  html += ".btn-on { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }";
  html += ".btn-off { background: linear-gradient(135deg, #606c88 0%, #3f4c6b 100%); color: white; }";
  html += ".btn-auto { background: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%); color: white; }";
  html += ".footer { text-align: center; color: #ffffff; margin-top: 35px; font-size: 1em; font-weight: 600; }";
  html += ".footer a { color: #ffffff; text-decoration: none; font-weight: bold; }";
  html += ".footer a:hover { text-decoration: underline; }";
  html += "</style>";
  
  // JavaScript for auto-refresh and manual control
  html += "<script>";
  html += "function updateData() {";
  html += "  fetch('/data').then(r => r.json()).then(data => {";
  html += "    document.getElementById('temp').innerText = data.temperature;";
  html += "    document.getElementById('hum').innerText = data.humidity;";
  html += "    document.getElementById('soil').innerText = data.soilMoisture;";
  html += "    ";
  html += "    const pumpCard = document.getElementById('pump-card');";
  html += "    const pumpIcon = document.getElementById('pump-icon');";
  html += "    const pumpText = document.getElementById('pump-text');";
  html += "    if(data.pumpStatus) {";
  html += "      pumpCard.className = 'status-item active-green';";
  html += "      pumpIcon.innerText = 'üíß';";
  html += "      pumpText.innerText = 'PUMP ON';";
  html += "    } else {";
  html += "      pumpCard.className = 'status-item';";
  html += "      pumpIcon.innerText = 'üö∞';";
  html += "      pumpText.innerText = 'PUMP OFF';";
  html += "    }";
  html += "    ";
  html += "    const ledCard = document.getElementById('led-card');";
  html += "    const ledIcon = document.getElementById('led-icon');";
  html += "    const ledText = document.getElementById('led-text');";
  html += "    if(data.ledStatus) {";
  html += "      ledCard.className = 'status-item active-green';";
  html += "      ledIcon.innerText = 'üí°';";
  html += "      ledText.innerText = 'LED ON';";
  html += "    } else {";
  html += "      ledCard.className = 'status-item';";
  html += "      ledIcon.innerText = 'üî¶';";
  html += "      ledText.innerText = 'LED OFF';";
  html += "    }";
  html += "    ";
  html += "    const motorCard = document.getElementById('motor-card');";
  html += "    const motorIcon = document.getElementById('motor-icon');";
  html += "    const motorText = document.getElementById('motor-text');";
  html += "    if(data.motorStatus) {";
  html += "      motorCard.className = 'status-item active-green';";
  html += "      motorIcon.innerText = 'üåÄ';";
  html += "      motorText.innerText = 'MOTOR ON';";
  html += "    } else {";
  html += "      motorCard.className = 'status-item';";
  html += "      motorIcon.innerText = '‚öôÔ∏è';";
  html += "      motorText.innerText = 'MOTOR OFF';";
  html += "    }";
  html += "    ";
  html += "    const flameCard = document.getElementById('flame-card');";
  html += "    const flameIcon = document.getElementById('flame-icon');";
  html += "    const flameText = document.getElementById('flame-text');";
  html += "    if(data.flameDetected) {";
  html += "      flameCard.className = 'status-item active-green';";
  html += "      flameIcon.innerText = 'üî•';";
  html += "      flameText.innerText = 'FIRE ALERT!';";
  html += "    } else {";
  html += "      flameCard.className = 'status-item';";
  html += "      flameIcon.innerText = '‚úÖ';";
  html += "      flameText.innerText = 'NO FIRE';";
  html += "    }";
  html += "  });";
  html += "}";
  html += "setInterval(updateData, 1000);";
  html += "function sendControl(device, action) {";
  html += "  fetch('/control?' + device + '=' + action).then(() => setTimeout(updateData, 300));";
  html += "}";
  html += "</script>";
  
  html += "</head>";
  html += "<body>";
  html += "<div class='container'>";
  
  // Header
  html += "<div class='header'>";
  html += "<h1>üå± Smart Agriculture System</h1>";
  html += "<p>ESP32 IoT Monitoring & Control</p>";
  html += "</div>";
  
  // Sensor Cards
  html += "<div class='sensor-grid'>";
  
  html += "<div class='sensor-card'>";
  html += "<div class='sensor-label'>üå°Ô∏è Temperature</div>";
  html += "<div class='sensor-value' id='temp'>" + String(temperature, 1) + "</div>";
  html += "<div class='sensor-unit'>¬∞C</div>";
  html += "</div>";
  
  html += "<div class='sensor-card'>";
  html += "<div class='sensor-label'>üíß Humidity</div>";
  html += "<div class='sensor-value' id='hum'>" + String(humidity, 1) + "</div>";
  html += "<div class='sensor-unit'>%</div>";
  html += "</div>";
  
  html += "<div class='sensor-card'>";
  html += "<div class='sensor-label'>üåø Soil Moisture</div>";
  html += "<div class='sensor-value' id='soil'>" + String(soilPercent) + "</div>";
  html += "<div class='sensor-unit'>%</div>";
  html += "</div>";
  
  html += "</div>"; // End sensor-grid
  
  // Status Section
  html += "<div class='status-section'>";
  html += "<h2>‚ö° System Status</h2>";
  html += "<div class='status-grid'>";
  
  // Pump Status
  html += "<div class='status-item'>";
  html += "<div class='status-icon'>";
  html += (pumpStatus == "ON") ? "üíß" : "üö∞";
  html += "</div>";
  html += "<div class='status-text'>";
  html += (pumpStatus == "ON") ? "PUMP ON" : "PUMP OFF";
  html += "</div>";
  html += "<div class='control-buttons'>";
  html += "<button class='btn btn-on' onclick='sendControl(\"pump\", \"on\")'>ON</button>";
  html += "<button class='btn btn-off' onclick='sendControl(\"pump\", \"off\")'>OFF</button>";
  html += "<button class='btn btn-auto' onclick='sendControl(\"pump\", \"auto\")'>AUTO</button>";
  html += "</div>";
  html += "</div>";
  
  // LED Status
  html += "<div class='status-item'>";
  html += "<div class='status-icon'>";
  html += (ledStatus == "ON") ? "üí°" : "üî¶";
  html += "</div>";
  html += "<div class='status-text'>";
  html += (ledStatus == "ON") ? "LED ON" : "LED OFF";
  html += "</div>";
  html += "<div class='control-buttons'>";
  html += "<button class='btn btn-on' onclick='sendControl(\"led\", \"on\")'>ON</button>";
  html += "<button class='btn btn-off' onclick='sendControl(\"led\", \"off\")'>OFF</button>";
  html += "<button class='btn btn-auto' onclick='sendControl(\"led\", \"auto\")'>AUTO</button>";
  html += "</div>";
  html += "</div>";
  
  // Motor Status with Manual Controls (NEW)
  html += "<div class='status-item'>";
  html += "<div class='status-icon'>";
  html += (motorStatus == "ON") ? "üåÄ" : "‚öôÔ∏è";
  html += "</div>";
  html += "<div class='status-text'>";
  html += (motorStatus == "ON") ? "MOTOR ON" : "MOTOR OFF";
  html += "</div>";
  html += "<div class='control-buttons'>";
  html += "<button class='btn btn-on' onclick='sendControl(\"motor\", \"on\")'>ON</button>";
  html += "<button class='btn btn-off' onclick='sendControl(\"motor\", \"off\")'>OFF</button>";
  html += "<button class='btn btn-auto' onclick='sendControl(\"motor\", \"auto\")'>AUTO</button>";
  html += "</div>";
  html += "</div>";
  
  // Flame Status (no manual control)
  html += "<div class='status-item'>";
  html += "<div class='status-icon'>";
  html += (flameStatus == "FIRE") ? "üî•" : "‚úÖ";
  html += "</div>";
  html += "<div class='status-text'>";
  html += (flameStatus == "FIRE") ? "FIRE ALERT!" : "NO FIRE";
  html += "</div>";
  html += "</div>";
  
  html += "</div>"; // End status-grid
  html += "</div>"; // End status-section
  
  // Footer
  html += "<div class='footer'>";
  html += "üöÄ ESP32 Smart Agriculture | Auto-refresh: 1s | ";
  html += "<a href='/'>Refresh</a>";
  html += "</div>";
  
  html += "</div>"; // End container
  html += "</body></html>";
  
  server.send(200, "text/html", html);
}